<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon Traitement de Texte Avancé</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Playfair+Display:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Définition des variables pour les deux thèmes */
        :root {
            --body-bg: #f4f4f4;
            --text-color: #333;
            --editor-bg: #fff;
            --editor-border: #ccc;
            --toolbar-bg: #e0e0e0;
            --toolbar-border: #ccc;
            --button-bg: #ddd;
            --button-hover-bg: #ccc;
            --dropdown-bg: #f9f9f9;
            --dropdown-hover-bg: #f1f1f1;
            --menu-bg: #e9e9e9;
        }
        body.dark-mode {
            --body-bg: #1a1a1a;
            --text-color: #e0e0e0;
            --editor-bg: #222;
            --editor-border: #333;
            --toolbar-bg: #2a2a2a;
            --toolbar-border: #333;
            --button-bg: #333;
            --button-hover-bg: #444;
            --dropdown-bg: #2a2a2a;
            --dropdown-hover-bg: #3a3a3a;
            --menu-bg: #222;
        }

        /* Styles généraux */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--body-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            margin: 20px;
        }
        h1 { text-align: center; }
        #editor {
            height: 400px;
            background-color: var(--editor-bg);
            border: 1px solid var(--editor-border);
        }

        /* Styles de la barre de menus */
        .main-menu {
            background-color: var(--menu-bg);
            border-bottom: 1px solid var(--toolbar-border);
            padding: 8px 16px;
            display: flex;
            gap: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .menu-item {
            position: relative;
            cursor: pointer;
            font-weight: bold;
        }
        .menu-item:hover {
            text-decoration: underline;
        }
        .menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--dropdown-bg);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            padding: 5px 0;
        }
        .menu-dropdown a {
            color: var(--text-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .menu-dropdown a:hover {
            background-color: var(--dropdown-hover-bg);
        }
        .menu-item:hover .menu-dropdown {
            display: block;
        }

        /* Styles de la barre d'outils Quill */
        .ql-toolbar.ql-snow {
            background: var(--toolbar-bg);
            border: 1px solid var(--toolbar-border) !important;
            border-bottom: none !important;
        }
        .ql-container.ql-snow {
            border: 1px solid var(--editor-border) !important;
        }

        /* Styles des boutons (pour les boutons Annuler/Rétablir) */
        .toolbar-group {
            display: flex;
            gap: 5px;
        }
        button {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            background-color: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--editor-border);
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: var(--button-hover-bg);
        }

        /* Pied de page pour le compteur de mots */
        .footer {
            margin-top: 10px;
            text-align: right;
            font-size: 14px;
        }

        /* NOUVELLE LOGIQUE POUR L'IMPRESSION */
        @media print {
            body * { visibility: hidden; }
            #editor, #editor * { visibility: visible; }
            #editor {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                border: none !important;
                background-color: white;
                color: black;
            }
        }
    </style>
</head>
<body>
    <nav class="main-menu">
        <div class="menu-item">
            Fichier
            <div class="menu-dropdown">
                <a href="#" id="save-btn">Sauvegarder</a>
                <a href="#" id="load-btn">Charger</a>
                <a href="#" id="import-btn">Importer...</a>
                <div class="dropdown-container">
                    <a href="#">Télécharger...</a>
                    <div id="downloadDropdown" class="menu-dropdown show-on-click">
                        <a href="#" id="download-html">HTML (UTF-8)</a>
                        <a href="#" id="download-html-utf16">HTML (UTF-16)</a>
                        <a href="#" id="download-pdf">PDF</a>
                        <a href="#" id="download-txt">TXT (UTF-8)</a>
                        <a href="#" id="download-txt-utf16">TXT (UTF-16)</a>
                        <a href="#" id="download-md">Markdown</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="menu-item">
            Édition
            <div class="menu-dropdown">
                <a href="#" id="undo-btn">Annuler (Ctrl+Z)</a>
                <a href="#" id="redo-btn">Rétablir (Ctrl+Y)</a>
                <a href="#" id="check-btn">Vérifier l'orthographe</a>
            </div>
        </div>
        <div class="menu-item">
            Affichage
            <div class="menu-dropdown">
                <a href="#" id="dark-mode-btn">Mode Nuit</a>
                <a href="#" id="fullscreen-btn">Plein écran</a>
            </div>
        </div>
        <a href="#" id="print-btn" style="text-decoration: none; font-weight: bold; color: inherit;">Imprimer</a>
        <input type="file" id="file-input" accept=".html,.txt" style="display:none;">
    </nav>
    <div class="container">
        <div id="editor" spellcheck="true"></div>
        <div class="footer">
            Mots : <span id="word-count">0</span> |
            Caractères : <span id="char-count">0</span>
            <span id="auto-save-status" style="margin-left: 20px;"></span>
        </div>
    </div>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/turndown@7.1.3/dist/turndown.js"></script>
    <script>
        const Font = Quill.import('formats/font');
        Font.whitelist = ['sans-serif', 'serif', 'monospace', 'Open Sans', 'Roboto', 'Playfair Display', 'Lato', 'Montserrat'];
        Quill.register(Font, true);

        const toolbarOptions = [
            [{ 'font': Font.whitelist }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'align': [] }],
            ['link', 'image', 'video'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'header': [1, 2, 3, false] }],
            ['clean']
        ];
        
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: toolbarOptions,
                history: { delay: 2000, maxStack: 50, userOnly: true },
                keyboard: {
                    bindings: {
                        save: { key: 'S', shortKey: true, handler: saveDocument },
                        print: { key: 'P', shortKey: true, handler: window.print }
                    }
                }
            }
        });

        // --- Correcteur orthographique ---
        let lastSpellCheckContent = "";
        
        async function checkSpelling() {
            const text = quill.getText();
            if (text === lastSpellCheckContent) {
                return; // Pas de changement, pas besoin de vérifier
            }

            // Enlever les surbrillances existantes
            const editorContent = quill.getContents();
            const operations = [];
            let i = 0;
            while(i < editorContent.ops.length) {
                const op = editorContent.ops[i];
                if (op.attributes && op.attributes.background) {
                    operations.push({ retain: op.retain || op.insert.length, attributes: { background: null } });
                } else if (op.insert) {
                    operations.push({ retain: op.insert.length });
                }
                i++;
            }
            quill.updateContents(operations);
            
            const url = 'https://languagetool.org/api/v2/check';
            const params = new URLSearchParams({
                text: text,
                language: 'fr'
            });

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params
                });
                const data = await response.json();

                data.matches.forEach(match => {
                    const start = match.offset;
                    const length = match.length;
                    
                    quill.formatText(start, length, 'background', 'rgba(255, 0, 0, 0.2)');
                });
                lastSpellCheckContent = text;
                console.log("Vérification orthographique terminée !");

            } catch (error) {
                console.error('Erreur lors de la vérification orthographique :', error);
            }
        }
        
        // Écouteur pour la vérification automatique
        quill.on('text-change', () => {
            // Appelez la vérification après un petit délai
            setTimeout(checkSpelling, 1000); 
            updateCounts();
        });

        // --- Fin Correcteur orthographique ---
        
        let lastSavedContent = JSON.stringify(quill.getContents());
        const autoSaveStatus = document.getElementById('auto-save-status');
        const autoSaveInterval = 30 * 1000;

        function saveDocument() {
            try {
                const content = JSON.stringify(quill.getContents());
                localStorage.setItem('quill-document', content);
                lastSavedContent = content;
                autoSaveStatus.textContent = 'Sauvegardé !';
                console.log('Document sauvegardé localement !');
            } catch (e) {
                autoSaveStatus.textContent = 'Erreur de sauvegarde';
                console.error('Erreur lors de la sauvegarde : ', e.message);
            }
        }
        function loadDocument() {
            try {
                const content = localStorage.getItem('quill-document');
                if (content) {
                    quill.setContents(JSON.parse(content));
                    lastSavedContent = content;
                    console.log('Document chargé depuis le stockage local !');
                } else {
                    console.log('Aucun document sauvegardé.');
                }
            } catch (e) {
                console.error('Erreur lors du chargement : ', e.message);
            }
        }
        function autoSaveDocument() {
            const currentContent = JSON.stringify(quill.getContents());
            if (currentContent !== lastSavedContent) {
                saveDocument();
                autoSaveStatus.textContent = 'Sauvegarde automatique...';
            } else {
                autoSaveStatus.textContent = 'Aucun changement';
            }
        }
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                quill.root.innerHTML = e.target.result;
            };
            reader.readAsText(file);
        }
        function createAndClickLink(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        const downloaders = {
            html: () => {
                const content = quill.root.innerHTML;
                const blob = new Blob([content], { type: "text/html;charset=utf-8" });
                createAndClickLink(blob, "document.html");
            },
            htmlUTF16: () => {
                const content = quill.root.innerHTML;
                const encoder = new TextEncoder("utf-16le");
                const utf16Content = encoder.encode(content);
                const blob = new Blob([utf16Content], { type: "text/html;charset=utf-16" });
                createAndClickLink(blob, "document_utf16.html");
            },
            pdf: () => {
                const element = document.createElement("div");
                element.innerHTML = quill.root.innerHTML;
                html2pdf().from(element).save("document.pdf");
            },
            txt: () => {
                const content = quill.getText();
                const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                createAndClickLink(blob, "document.txt");
            },
            txtUTF16: () => {
                const content = quill.getText();
                const encoder = new TextEncoder("utf-16le");
                const utf16Content = encoder.encode(content);
                const blob = new Blob([utf16Content], { type: "text/plain;charset=utf-16" });
                createAndClickLink(blob, "document_utf16.txt");
            },
            md: () => {
                const turndownService = new TurndownService();
                const markdown = turndownService.turndown(quill.root.innerHTML);
                const blob = new Blob([markdown], { type: "text/markdown;charset=utf-8" });
                createAndClickLink(blob, "document.md");
            }
        };
        function toggleFullscreen() {
            const elem = document.documentElement;
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                elem.requestFullscreen().catch(err => {
                    console.error(`Erreur: ${err.message}`);
                });
            }
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
        }
        function updateCounts() {
            const text = quill.getText();
            const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
            const charCount = text.length;
            document.getElementById('word-count').textContent = wordCount;
            document.getElementById('char-count').textContent = charCount;
        }
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); }
            loadDocument();
            updateCounts();
            // setInterval(autoSaveDocument, autoSaveInterval);
        });
        quill.on('text-change', updateCounts);

        document.getElementById('save-btn').addEventListener('click', saveDocument);
        document.getElementById('load-btn').addEventListener('click', loadDocument);
        document.getElementById('import-btn').addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', handleFileImport);
        document.getElementById('undo-btn').addEventListener('click', () => quill.history.undo());
        document.getElementById('redo-btn').addEventListener('click', () => quill.history.redo());
        document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
        document.getElementById('print-btn').addEventListener('click', () => window.print());
        document.getElementById('dark-mode-btn').addEventListener('click', toggleDarkMode);
        document.getElementById('download-html').addEventListener('click', downloaders.html);
        document.getElementById('download-html-utf16').addEventListener('click', downloaders.htmlUTF16);
        document.getElementById('download-pdf').addEventListener('click', downloaders.pdf);
        document.getElementById('download-txt').addEventListener('click', downloaders.txt);
        document.getElementById('download-txt-utf16').addEventListener('click', downloaders.txtUTF16);
        document.getElementById('download-md').addEventListener('click', downloaders.md);
        document.getElementById('check-btn').addEventListener('click', checkSpelling);
    </script>
</body>
</html>
