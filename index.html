<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã‰diteur Hors Ligne</title>
    <!-- Quill CSS (Toujours via CDN pour l'instant, mais fonctionne en cache aprÃ¨s premier chargement) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            /* Couleurs Modernes & Douces */
            --app-bg: #f3f4f6;
            --paper-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);

            /* Dimensions Papier A4 (approx pour Ã©cran) */
            --page-width: 210mm;
            --page-min-height: 297mm;
        }

        body.dark-mode {
            --app-bg: #111827;
            --paper-bg: #1f2937;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--app-bg);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
            overflow: hidden; /* Scroll gÃ©rÃ© par la zone principale */
        }

        /* --- BARRE DU HAUT --- */
        .top-bar {
            background-color: var(--paper-bg);
            border-bottom: 1px solid var(--border);
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .logo {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Boutons stylisÃ©s */
        .btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-main);
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover {
            background-color: var(--app-bg);
            border-color: var(--border);
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: transparent;
        }

        /* Menus dÃ©roulants */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: var(--paper-bg);
            min-width: 200px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            z-index: 50;
            margin-top: 4px;
        }
        .dropdown-content a {
            color: var(--text-main);
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            font-size: 0.9rem;
        }
        .dropdown-content a:hover {
            background-color: var(--app-bg);
        }
        .dropdown:hover .dropdown-content { display: block; }


        /* --- ZONE Ã‰DITEUR (SCROLLABLE) --- */
        .workspace {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Effet Papier A4 */
        #editor-container {
            width: 100%;
            max-width: var(--page-width);
            min-height: var(--page-min-height);
            background-color: var(--paper-bg);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
            /* Quill override */
            border: none !important;
        }

        /* Quill Styles Overrides pour le look "Page" */
        .ql-container.ql-snow {
            border: none !important;
            font-family: 'Times New Roman', serif; /* DÃ©faut plus "littÃ©raire" */
            font-size: 16px;
        }
        .ql-editor {
            min-height: var(--page-min-height);
            padding: 2.5cm 2cm !important; /* Marges d'impression standard */
            line-height: 1.6;
        }

        /* Barre d'outils Quill flottante ou intÃ©grÃ©e */
        .ql-toolbar.ql-snow {
            border: none !important;
            border-bottom: 1px solid var(--border) !important;
            background-color: var(--paper-bg);
            position: sticky;
            top: 0;
            z-index: 5;
            text-align: center;
            width: 100%;
            max-width: var(--page-width);
            margin: 0 auto;
            border-radius: 4px 4px 0 0;
        }

        /* Status Bar (Flottante en bas Ã  droite) */
        .status-bar {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: var(--paper-bg);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            box-shadow: var(--shadow);
            font-size: 0.75rem;
            color: var(--text-muted);
            border: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            align-items: center;
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        .status-bar:hover { opacity: 1; }

        /* Impression */
        @media print {
            body > * { display: none; }
            .workspace { display: block; overflow: visible; padding: 0; margin: 0; }
            #editor-container {
                display: block;
                box-shadow: none;
                margin: 0;
                width: 100%;
                max-width: none;
            }
            .ql-editor { padding: 0 !important; }
            .ql-toolbar { display: none !important; }
        }
    </style>
</head>
<body>

    <!-- Barre de menu supÃ©rieure -->
    <header class="top-bar">
        <div class="logo">
            <span>ğŸ“ Ã‰diteur Zen</span>
        </div>

        <!-- Barre d'outils Quill sera dÃ©placÃ©e ici par JS ou laissÃ©e au dessus de la page -->

        <div class="actions">
            <button class="btn" id="dark-mode-btn" title="Changer de thÃ¨me">ğŸŒ—</button>
            <div class="dropdown">
                <button class="btn">Fichier â–¼</button>
                <div class="dropdown-content">
                    <a href="#" id="save-btn">ğŸ’¾ Sauvegarder maintenant</a>
                    <a href="#" id="load-btn">ğŸ“‚ Recharger derniÃ¨re sauvegarde</a>
                    <hr style="border:0; border-top:1px solid var(--border); margin:0;">
                    <a href="#" id="export-pdf">ğŸ“„ Exporter en PDF</a>
                    <a href="#" id="export-html">ğŸŒ Exporter en HTML</a>
                    <a href="#" id="export-txt">ğŸ“ Exporter en Texte</a>
                    <a href="#" id="import-btn">ğŸ“¥ Importer un fichier...</a>
                </div>
            </div>
            <button class="btn btn-primary" id="print-btn">Imprimer</button>
        </div>
    </header>

    <div class="workspace">
        <!-- Conteneur pour l'Ã©diteur -->
        <div id="editor-container">
            <div id="editor"></div>
        </div>
        <div class="status-bar">
            <span id="save-status">PrÃªt</span> |
            <span id="word-count">0 mots</span>
        </div>
    </div>

    <input type="file" id="file-input" style="display: none;" accept=".txt,.html,.md">

    <!-- Quill Lib -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        const Font = Quill.import('formats/font');
        Font.whitelist = ['arial', 'comic-sans', 'courier-new', 'georgia', 'helvetica', 'lucida', 'trebuchet', 'verdana', 'times-new-roman'];
        Quill.register(Font, true);

        const toolbarOptions = [
            [{ 'header': [1, 2, 3, false] }],
            [{ 'font': Font.whitelist }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }],
            ['link', 'image'],
            ['clean']
        ];

        // Initialisation de Quill
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: toolbarOptions,
                history: { delay: 1000, maxStack: 50, userOnly: true }
            },
            placeholder: 'Commencez Ã  Ã©crire votre chef-d\'Å“uvre ici...'
        });

        // DÃ©placement de la toolbar pour qu'elle soit "collÃ©e" au haut de la page papier ou de la fenÃªtre
        // (Quill gÃ©nÃ¨re la toolbar avant l'Ã©diteur, on peut la laisser lÃ  oÃ¹ elle est gÃ©nÃ©rÃ©e par dÃ©faut)

        // --- 2. FONCTIONS SYSTÃˆME (Garantie locale) ---

        const saveStatus = document.getElementById('save-status');
        const LOCAL_STORAGE_KEY = 'zen_editor_content';

        // Sauvegarde LocalStorage
        function saveLocal() {
            try {
                const content = JSON.stringify(quill.getContents());
                localStorage.setItem(LOCAL_STORAGE_KEY, content);
                showStatus("âœ… SauvegardÃ© (Navigateur)", 2000);
            } catch (e) {
                showStatus("âŒ Erreur stockage (Quota ?)", 3000);
                console.error(e);
            }
        }

        // Chargement LocalStorage
        function loadLocal() {
            const content = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (content) {
                quill.setContents(JSON.parse(content));
            }
        }

        // Helper Status
        let statusTimeout;
        function showStatus(msg, duration = 0) {
            saveStatus.textContent = msg;
            clearTimeout(statusTimeout);
            if (duration > 0) {
                statusTimeout = setTimeout(() => {
                    saveStatus.textContent = "PrÃªt";
                }, duration);
            }
        }

        // Auto-save intelligent
        let typingTimer;
        quill.on('text-change', () => {
            clearTimeout(typingTimer);
            saveStatus.textContent = "Ã‰criture...";
            updateCounts();

            // Sauvegarde 1 seconde aprÃ¨s avoir arrÃªtÃ© de taper
            typingTimer = setTimeout(saveLocal, 1000);
        });

        // --- 3. EXPORT / IMPORT ---

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('export-html').onclick = () => {
            const html = quill.root.innerHTML;
            const fullHtml = `<!DOCTYPE html><html><body style="font-family: sans-serif; max-width: 800px; margin: auto;">${html}</body></html>`;
            downloadFile(fullHtml, "document.html", "text/html");
        };

        document.getElementById('export-txt').onclick = () => {
            downloadFile(quill.getText(), "document.txt", "text/plain");
        };

        // PDF via impression systÃ¨me (Beaucoup plus lÃ©ger et propre que jsPDF)
        document.getElementById('export-pdf').onclick = () => {
            window.print();
        };

        document.getElementById('print-btn').onclick = () => window.print();

        // Import
        document.getElementById('import-btn').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                if(file.name.endsWith('.txt')) {
                    quill.setText(evt.target.result);
                } else {
                    // HTML par dÃ©faut
                    // Astuce pour insÃ©rer du HTML brut dans Quill
                    const div = document.createElement('div');
                    div.innerHTML = evt.target.result;
                    quill.root.innerHTML = div.innerHTML; // Simple et efficace
                }
                showStatus("Fichier chargÃ©");
            };
            reader.readAsText(file);
            e.target.value = ""; // Reset
        };


        // --- 4. UI / THEME ---

        function updateCounts() {
            const text = quill.getText();
            const words = text.trim().length === 0 ? 0 : text.trim().split(/\s+/).length;
            document.getElementById('word-count').textContent = `${words} mots`;
        }

        document.getElementById('dark-mode-btn').onclick = () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('zen_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        };

        // Init
        if (localStorage.getItem('zen_theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
        loadLocal();

        // SÃ©curitÃ© fermeture
        window.onbeforeunload = () => {
            // Optionnel : avertir si changements non sauvegardÃ©s (ici auto-save gÃ¨re presque tout)
            // return "Avez-vous sauvegardÃ© ?";
        };

    </script>
</body>
</html>
