<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Traitement de Texte Léger</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Définition des variables pour les deux thèmes */
        :root {
            --body-bg: #f4f4f4;
            --text-color: #333;
            --editor-bg: #fff;
            --editor-border: #ccc;
            --toolbar-bg: #e0e0e0;
            --toolbar-border: #ccc;
            --button-bg: #ddd;
            --button-hover-bg: #ccc;
            --dropdown-bg: #f9f9f9;
            --dropdown-hover-bg: #f1f1f1;
            --menu-bg: #e9e9e9;
        }
        body.dark-mode {
            --body-bg: #1a1a1a;
            --text-color: #e0e0e0;
            --editor-bg: #222;
            --editor-border: #333;
            --toolbar-bg: #2a2a2a;
            --toolbar-border: #333;
            --button-bg: #333;
            --button-hover-bg: #444;
            --dropdown-bg: #2a2a2a;
            --dropdown-hover-bg: #3a3a3a;
            --menu-bg: #222;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            background-color: var(--body-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            margin: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        h1 { text-align: center; }
        #editor {
            height: 60vh;
            min-height: 400px;
            background-color: var(--editor-bg);
            border: 1px solid var(--editor-border);
        }

        /* Styles de la barre de menus */
        .main-menu {
            background-color: var(--menu-bg);
            border-bottom: 1px solid var(--toolbar-border);
            padding: 8px 16px;
            display: flex;
            gap: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            align-items: center;
            flex-wrap: wrap;
        }
        .menu-item {
            position: relative;
            cursor: pointer;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            user-select: none;
        }
        .menu-item:hover {
            background-color: var(--button-hover-bg);
        }
        .menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--dropdown-bg);
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 5px;
            padding: 5px 0;
        }
        .menu-dropdown a {
            color: var(--text-color);
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            font-weight: normal;
        }
        .menu-dropdown a:hover {
            background-color: var(--dropdown-hover-bg);
        }
        .menu-item:hover .menu-dropdown {
            display: block;
        }
        
        /* Sous-menu (pour Télécharger) */
        .dropdown-container {
            position: relative;
        }
        .dropdown-container:hover .show-on-click {
            display: block;
            top: 0;
            left: 100%;
            margin-top: -5px;
        }

        /* Styles de la barre d'outils Quill */
        .ql-toolbar.ql-snow {
            background: var(--toolbar-bg);
            border: 1px solid var(--toolbar-border) !important;
            border-bottom: none !important;
            border-radius: 4px 4px 0 0;
        }
        .ql-container.ql-snow {
            border: 1px solid var(--editor-border) !important;
            border-radius: 0 0 4px 4px;
        }

        /* Définition CSS des polices Standard pour Quill */
        .ql-font-arial { font-family: 'Arial', sans-serif; }
        .ql-font-comic-sans { font-family: 'Comic Sans MS', cursive; }
        .ql-font-courier-new { font-family: 'Courier New', monospace; }
        .ql-font-georgia { font-family: 'Georgia', serif; }
        .ql-font-helvetica { font-family: 'Helvetica', sans-serif; }
        .ql-font-lucida { font-family: 'Lucida Sans Unicode', sans-serif; }
        .ql-font-tahoma { font-family: 'Tahoma', sans-serif; }
        .ql-font-times-new-roman { font-family: 'Times New Roman', serif; }
        .ql-font-trebuchet { font-family: 'Trebuchet MS', sans-serif; }
        .ql-font-verdana { font-family: 'Verdana', sans-serif; }


        /* Pied de page pour le compteur de mots */
        .footer {
            margin-top: 10px;
            text-align: right;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }

        /* Impression */
        @media print {
            body * { visibility: hidden; }
            #editor, #editor * { visibility: visible; }
            #editor {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                border: none !important;
                background-color: white;
                color: black;
                overflow: visible;
            }
            .ql-tooltip { display: none !important; }
        }
    </style>
</head>
<body>
    <nav class="main-menu">
        <div class="menu-item">
            Fichier
            <div class="menu-dropdown">
                <a href="#" id="save-btn">Sauvegarder (Local)</a>
                <a href="#" id="load-btn">Charger (Local)</a>
                <a href="#" id="import-btn">Importer un fichier...</a>
                <div class="dropdown-container">
                    <a href="#">Télécharger en... &#9656;</a>
                    <div id="downloadDropdown" class="menu-dropdown show-on-click">
                        <a href="#" id="download-html">HTML (UTF-8)</a>
                        <a href="#" id="download-html-utf16">HTML (UTF-16)</a>
                        <a href="#" id="download-pdf">PDF</a>
                        <a href="#" id="download-txt">TXT (UTF-8)</a>
                        <a href="#" id="download-txt-utf16">TXT (UTF-16)</a>
                        <a href="#" id="download-md">Markdown</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="menu-item">
            Édition
            <div class="menu-dropdown">
                <a href="#" id="undo-btn">Annuler (Ctrl+Z)</a>
                <a href="#" id="redo-btn">Rétablir (Ctrl+Y)</a>
                <a href="#" id="check-btn">Vérifier l'orthographe</a>
            </div>
        </div>
        <div class="menu-item">
            Affichage
            <div class="menu-dropdown">
                <a href="#" id="dark-mode-btn">Mode Nuit/Jour</a>
                <a href="#" id="fullscreen-btn">Plein écran</a>
            </div>
        </div>
        <div class="menu-item" id="print-btn">Imprimer</div>
        <input type="file" id="file-input" accept=".html,.txt" style="display:none;">
    </nav>
    <div class="container">
        <div id="editor" spellcheck="false"></div>
        <div class="footer">
            Mots : <span id="word-count">0</span> |
            Caractères : <span id="char-count">0</span>
            <span id="auto-save-status" style="margin-left: 20px;"></span>
        </div>
    </div>
    
    <!-- Quill Core -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        // --- Configuration Quill avec Polices Standards
        const Font = Quill.import('formats/font');
        // Liste des polices Web Safe
        const fonts = [
            'arial', 'comic-sans', 'courier-new', 'georgia', 
            'helvetica', 'lucida', 'tahoma', 'times-new-roman', 
            'trebuchet', 'verdana'
        ];
        Font.whitelist = fonts;
        Quill.register(Font, true);

        const toolbarOptions = [
            [{ 'font': fonts }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'align': [] }],
            ['link', 'image'], 
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'header': [1, 2, 3, false] }],
            ['clean']
        ];
        
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: toolbarOptions,
                history: { 
                    delay: 2000, 
                    maxStack: 25, 
                    userOnly: true 
                },
                keyboard: {
                    bindings: {
                        save: { key: 'S', shortKey: true, handler: saveDocument },
                        print: { key: 'P', shortKey: true, handler: window.print }
                    }
                }
            }
        });

        // --- Lazy Loading Helper ---
        function loadScript(url) {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${url}"]`)) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // --- Correcteur orthographique ---
        let isChecking = false;
        
        async function checkSpelling() {
            if (isChecking) return;
            isChecking = true;
            document.getElementById('check-btn').textContent = "Vérification...";
            
            // Nettoyage 
            quill.formatText(0, quill.getLength(), 'background', false);
            
            const text = quill.getText();
            
            // Si le texte est trop long, on tronque pour l'API pour éviter crash
            const textToSend = text.length > 20000 ? text.substring(0, 20000) : text;

            const params = new URLSearchParams({
                text: textToSend,
                language: 'fr',
                enabledOnly: 'false'
            });

            try {
                const response = await fetch('https://languagetool.org/api/v2/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });
                
                if (!response.ok) throw new Error('Erreur API');
                
                const data = await response.json();

                // LIMITATION: 50 premières fautes pour sauver le DOM
                const matches = data.matches.slice(0, 50); 
                
                matches.forEach(match => {
                    quill.formatText(match.offset, match.length, 'background', 'rgba(255, 0, 0, 0.2)');
                });
                
                if(data.matches.length === 0) {
                    alert("Aucune faute trouvée !");
                } else if(data.matches.length > 50) {
                    alert(`Attention : ${data.matches.length} fautes trouvées. Seules les 50 premières sont affichées pour la performance.`);
                }

            } catch (error) {
                console.error('Erreur vérification:', error);
                alert("Erreur technique ou limite API atteinte.");
            } finally {
                isChecking = false;
                document.getElementById('check-btn').textContent = "Vérifier l'orthographe";
            }
        }

        // --- Gestion Sauvegarde ---
        let lastSavedContent = "";
        const autoSaveStatus = document.getElementById('auto-save-status');

        function saveDocument() {
            try {
                const content = JSON.stringify(quill.getContents());
                localStorage.setItem('quill-document', content);
                lastSavedContent = content;
                autoSaveStatus.textContent = 'Sauvegardé !';
                setTimeout(() => { autoSaveStatus.textContent = ''; }, 2000);
            } catch (e) {
                autoSaveStatus.textContent = 'Erreur sauvegarde';
                console.error(e);
            }
        }

        function loadDocument() {
            try {
                const content = localStorage.getItem('quill-document');
                if (content) {
                    const parsed = JSON.parse(content);
                    quill.setContents(parsed);
                    lastSavedContent = content; // String reference
                }
            } catch (e) {
                console.error(e);
            }
        }

        function autoSaveDocument() {
            // Création string temporaire
            const currentContent = JSON.stringify(quill.getContents());
            if (currentContent !== lastSavedContent && currentContent.length > 20) {
                saveDocument();
                autoSaveStatus.textContent = 'Auto-save...';
            }
            // La variable currentContent sortira du scope ici pour le GC
        }

        // --- Export / Import ---
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (file.name.endsWith('.txt')) {
                    quill.setText(e.target.result);
                } else {
                    const container = document.createElement('div');
                    container.innerHTML = e.target.result;
                    quill.root.innerHTML = container.innerHTML;
                    container.innerHTML = ""; 
                }
                event.target.value = ''; 
            };
            reader.readAsText(file);
        }

        function createAndClickLink(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); 
        }

        function strToUTF16LE(str) {
            const buf = new ArrayBuffer(str.length * 2);
            const bufView = new Uint16Array(buf);
            for (let i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }

        const downloaders = {
            html: () => {
                const blob = new Blob([quill.root.innerHTML], { type: "text/html;charset=utf-8" });
                createAndClickLink(blob, "document.html");
            },
            htmlUTF16: () => {
                const blob = new Blob([strToUTF16LE(quill.root.innerHTML)], { type: "text/html;charset=utf-16" });
                createAndClickLink(blob, "document_utf16.html");
            },
            pdf: async () => {
                autoSaveStatus.textContent = "Module PDF...";
                try {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js');
                    const element = document.createElement("div");
                    element.innerHTML = quill.root.innerHTML;
                    element.style.fontFamily = "Arial, sans-serif";
                    element.style.fontSize = "12pt";
                    
                    const opt = {
                        margin: 10,
                        filename: 'document.pdf',
                        image: { type: 'jpeg', quality: 0.90 }, 
                        html2canvas: { scale: 1.5 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };
                    
                    await html2pdf().set(opt).from(element).save();
                    
                    // Nettoyage
                    element.innerHTML = "";
                    autoSaveStatus.textContent = "";
                } catch (e) {
                    alert("Erreur PDF: " + e.message);
                }
            },
            txt: () => {
                const blob = new Blob([quill.getText()], { type: "text/plain;charset=utf-8" });
                createAndClickLink(blob, "document.txt");
            },
            txtUTF16: () => {
                const blob = new Blob([strToUTF16LE(quill.getText())], { type: "text/plain;charset=utf-16" });
                createAndClickLink(blob, "document_utf16.txt");
            },
            md: async () => {
                autoSaveStatus.textContent = "Module MD...";
                try {
                    await loadScript('https://cdn.jsdelivr.net/npm/turndown@7.1.3/dist/turndown.js');
                    const turndownService = new TurndownService();
                    const markdown = turndownService.turndown(quill.root.innerHTML);
                    const blob = new Blob([markdown], { type: "text/markdown;charset=utf-8" });
                    createAndClickLink(blob, "document.md");
                    autoSaveStatus.textContent = "";
                } catch (e) {
                    alert("Erreur MD: " + e.message);
                }
            }
        };

        // --- Fonctions UI ---
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.error(e));
            } else {
                document.exitFullscreen();
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        function updateCounts() {
            const text = quill.getText();
            const wordCount = text.trim().length === 0 ? 0 : text.trim().split(/\s+/).length;
            const charCount = text.length > 1 ? text.length - 1 : 0; 
            document.getElementById('word-count').textContent = wordCount;
            document.getElementById('char-count').textContent = charCount;
        }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); }
            
            loadDocument();
            updateCounts();
            
            // Auto-save
            setInterval(autoSaveDocument, 60000);
        });

        // Event Listeners
        quill.on('text-change', updateCounts);

        document.getElementById('save-btn').addEventListener('click', (e) => { e.preventDefault(); saveDocument(); });
        document.getElementById('load-btn').addEventListener('click', (e) => { e.preventDefault(); loadDocument(); });
        document.getElementById('import-btn').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('file-input').click(); });
        document.getElementById('file-input').addEventListener('change', handleFileImport);
        
        document.getElementById('undo-btn').addEventListener('click', (e) => { e.preventDefault(); quill.history.undo(); });
        document.getElementById('redo-btn').addEventListener('click', (e) => { e.preventDefault(); quill.history.redo(); });
        document.getElementById('check-btn').addEventListener('click', (e) => { e.preventDefault(); checkSpelling(); });
        
        document.getElementById('fullscreen-btn').addEventListener('click', (e) => { e.preventDefault(); toggleFullscreen(); });
        document.getElementById('dark-mode-btn').addEventListener('click', (e) => { e.preventDefault(); toggleDarkMode(); });
        document.getElementById('print-btn').addEventListener('click', (e) => { e.preventDefault(); window.print(); });

        document.getElementById('download-html').addEventListener('click', (e) => { e.preventDefault(); downloaders.html(); });
        document.getElementById('download-html-utf16').addEventListener('click', (e) => { e.preventDefault(); downloaders.htmlUTF16(); });
        document.getElementById('download-pdf').addEventListener('click', (e) => { e.preventDefault(); downloaders.pdf(); });
        document.getElementById('download-txt').addEventListener('click', (e) => { e.preventDefault(); downloaders.txt(); });
        document.getElementById('download-txt-utf16').addEventListener('click', (e) => { e.preventDefault(); downloaders.txtUTF16(); });
        document.getElementById('download-md').addEventListener('click', (e) => { e.preventDefault(); downloaders.md(); });

    </script>
</body>
</html>
