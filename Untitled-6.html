<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon Traitement de Texte Avancé</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Roboto&display=swap" rel="stylesheet">

    <style>
        #editor {
            height: 400px;
            background: #fff;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        button {
            margin-top: 10px;
            margin-right: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        @media print {
            button, .ql-toolbar {
                display: none !important;
            }
        }
        
        /* Styles pour le mode nuit */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        body.dark-mode .ql-toolbar.ql-snow {
            background-color: #2a2a2a;
            border-color: #333;
        }
        body.dark-mode .ql-container.ql-snow {
            border-color: #333;
        }
        body.dark-mode #editor {
            background-color: #222;
            color: #e0e0e0;
        }
        body.dark-mode .dropdown-menu {
            background-color: #2a2a2a;
            box-shadow: 0px 8px 16px 0px rgba(255,255,255,0.1);
        }
        body.dark-mode .dropdown-menu a {
            color: #e0e0e0;
        }
        body.dark-mode .dropdown-menu a:hover {
            background-color: #3a3a3a;
        }

        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
        }

        .dropdown-menu a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-menu a:hover {
            background-color: #f1f1f1;
        }

        .show {
            display: block;
        }
    </style>
</head>
<body>
    <h1>Mon Traitement de Texte</h1>
    <div id="editor" spellcheck="true"></div>
    <br>
    <div>
        <button onclick="saveDocument()">Sauvegarder</button>
        <button onclick="loadDocument()">Charger</button>
        
        <div class="dropdown-container">
            <button onclick="toggleDropdown()">Télécharger</button>
            <div id="downloadDropdown" class="dropdown-menu">
                <a href="#" onclick="downloadHTML()">HTML</a>
                <a href="#" onclick="downloadPDF()">PDF</a>
                <a href="#" onclick="downloadTXT()">TXT</a>
                <a href="#" onclick="downloadMD()">Markdown</a>
            </div>
        </div>

        <button onclick="document.getElementById('file-input').click()">Importer</button>
        <button onclick="quill.history.undo()">Annuler</button>
        <button onclick="quill.history.redo()">Rétablir</button>
        <button onclick="toggleFullscreen()">Plein écran</button>
        <button onclick="window.print()">Imprimer</button>
        <button onclick="toggleDarkMode()">Mode Nuit</button>
        <input type="file" id="file-input" accept=".html,.txt" style="display:none;">
    </div>
    <p>
        Mots : <span id="word-count">0</span> |
        Caractères : <span id="char-count">0</span>
    </p>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/turndown@7.1.3/dist/turndown.js"></script>

    <script>
        // Ajout des polices personnalisées
        var Font = Quill.import('formats/font');
        Font.whitelist = ['sans-serif', 'serif', 'monospace', 'Open Sans', 'Roboto'];
        Quill.register(Font, true);

        // Initialisation de Quill
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'font': Font.whitelist }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['link', 'image', 'video'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'header': [1, 2, 3, false] }],
                    ['clean']
                ],
                history: {
                    delay: 2000,
                    maxStack: 50,
                    userOnly: true
                },
                keyboard: {
                    bindings: {
                        // Sauvegarder avec Ctrl+S
                        save: {
                            key: 'S',
                            shortKey: true,
                            handler: function() {
                                saveDocument();
                            }
                        },
                        // Imprimer avec Ctrl+P
                        print: {
                            key: 'P',
                            shortKey: true,
                            handler: function() {
                                window.print();
                            }
                        }
                    }
                }
            }
        });

        // Fonctions de téléchargement
        function downloadHTML() {
            var html = quill.root.innerHTML;
            var blob = new Blob([html], { type: "text/html;charset=utf-8" });
            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "document.html";
            link.click();
        }

        function downloadPDF() {
            var element = document.createElement("div");
            element.innerHTML = quill.root.innerHTML;
            html2pdf().from(element).save("document.pdf");
        }

        function downloadTXT() {
            var text = quill.getText();
            var blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "document.txt";
            link.click();
        }

        function downloadMD() {
            var turndownService = new TurndownService();
            var html = quill.root.innerHTML;
            var markdown = turndownService.turndown(html);

            var blob = new Blob([markdown], { type: "text/markdown;charset=utf-8" });
            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "document.md";
            link.click();
        }

        // Fonctions de gestion de document
        function saveDocument() {
            var content = JSON.stringify(quill.getContents());
            localStorage.setItem('quill-document', content);
            alert('Document sauvegardé localement !');
        }

        function loadDocument() {
            var content = localStorage.getItem('quill-document');
            if (content) {
                quill.setContents(JSON.parse(content));
                alert('Document chargé depuis le stockage local !');
            } else {
                alert('Aucun document sauvegardé.');
            }
        }
        
        function toggleFullscreen() {
            var elem = document.getElementById("editor");
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                elem.requestFullscreen().catch(err => {
                    alert(`Erreur: ${err.message}`);
                });
            }
        }

        function toggleDropdown() {
            document.getElementById("downloadDropdown").classList.toggle("show");
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-container button')) {
                var dropdowns = document.getElementsByClassName("dropdown-menu");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // Fonctions du mode nuit
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        });

        // Compteur de mots et de caractères
        quill.on('text-change', function() {
            var text = quill.getText();
            var wordCount = text.split(/\s+/).filter(Boolean).length;
            var charCount = text.replace(/\s/g, '').length;

            document.getElementById('word-count').textContent = wordCount;
            document.getElementById('char-count').textContent = charCount;
        });

        // Importation de fichiers
        document.getElementById('file-input').addEventListener('change', function(event) {
            var file = event.target.files[0];
            if (!file) {
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                quill.root.innerHTML = content;
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>